<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.2.xsd">
	<header>
		<license></license>
		<title lang="en">User reputation points</title>
		<description lang="en">This will add the user reputation point system to your board</description>
		<author-notes lang="en">UMIL is required to run the installer. You can download the latest release at http://www.phpbb.com/mods/umil or using the package I included in contrib folder.</author-notes>
		<author-group>
			<author>
				<realname>Pungky</realname>
				<email>pungkerz@gmail.com</email>
				<username>idiotnesia</username>
				<homepage>http://mod.web.id</homepage>
			</author>
		</author-group>
		<mod-version>0.3.1</mod-version>
		<installation>
			<level>easy</level>
			<time>750</time>
			<target-version>3.0.4</target-version>
		</installation>
		<history>
				<entry>
				<date>2008-01-27</date>
				<rev-version>0.3.1</rev-version>
				<changelog lang="en">
					<change>[Change] MODX 1.2.2  Package</change>
					<change>[Change] Change the files encoding (I forget it again) </change>
					<change>[Change] Now user can see rep comment in deleted post and unauthed post</change>
					<change>[Feature] Bring back the recent reputation in ucp</change>
					<change>[Fix] Missing variable languages</change>
					<change>[Fix] Forget to add author notes and DIY in package</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-01-22</date>
				<rev-version>0.3.0</rev-version>
				<changelog lang="en">
					<change>[Change] Fully recoding</change>
					<change>[Change] Add reputation class</change>
					<change>[Feature] Database and module installer using UMIL</change>
					<change>[Change] Put reputation ranks in cache</change>
					<change>[Change] Reorganizing the language</change>
					<change>[Change] Display rep comment in popup windows</change>
					<change>[Fix] Problem when guest posts</change>
					<change>[Fix] Delete reputation for deleted user</change>
					<change>[Feature] Point management</change>
					<change>[Feature] Minimum and maximum rep point</change>
					<change>[Feature] New permissions: Can view comment and can give negative point</change>
					<change>[Removed] Reset point</change>
					<change>[Removed] Change user point (move to point management)</change>
					<change>[Removed] Registration bonus</change>
					<change>[Removed] Recent received point in ucp (will be implemented again in the next release)</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-08-13</date>
				<rev-version>0.2.0</rev-version>
				<changelog lang="en">
					<change>[feature] Rep comment now can be viewed by public</change>
					<change>[change] Change the icon</change>
					<change>[fix] Deleting rep comment when deleting post</change>
					<change>[fix] Disable reg bonus point when mod is disabled</change>
					<change>[feature] Rep power can increase by rep point factor</change>
					<change>[feature] New moderative permission: can delete reputation</change>
					<change>[feature] Reset all user reputation point</change>
					<change>[feature] Add forum exclusions</change>
					<change>[feature] Enable/disable comment</change>
					<change>[feature] Display rep power in user profile</change>
					<change>[fix] Bugs in display total of block</change>
					<change>[change] Create some php functions</change>
					<change>[fix] Some typo</change>
					<change>[feature] Rank/title based on rep points</change>
					<change>[change] Remove permission: user can view who gave reputation</change>
					<change>[feature] Option to force user to enter comment</change>
					<change>[change] MODX 1.2.0 Package</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-03-18</date>
				<rev-version>0.1.1</rev-version>
				<changelog lang="en">
					<change>Fix problem in multi language</change>
					<change>Add form token in the form</change>
					<change>Add redirection after successful giving eputation</change>
					<change>Now, users cannot give reputation in the same post</change>
					<change>Error messagge for max comment limit now displayed on the same page</change>
					<change>More friendly error messagge for max comment limit</change>
					<change>Change installation level from easy to intemediate</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-02-29</date>
				<rev-version>0.1.0a</rev-version>
				<changelog lang="en">
					<change>Fix bugs #3 - Problems in functions_user</change>
					<change>Fix missing instruction prosilver update</change>
					<change>Add new icon for text's display</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-02-28</date>
				<rev-version>0.1.0</rev-version>
				<changelog lang="en">
					<change>Fix bug #1: Guest does not redirect to loginbox</change>
					<change>Fix bug #2: Missing variable language in reputation body</change>
					<change>Fix some language (thanks jase951 for helping rephrase the language)</change>
					<change>New icon from dunv007 (thanks for such a nice icon)</change>
					<change>Display option: text and block</change>
					<change>Registration bonus</change>
					<change>Override default usergroup rep power</change>
					<change>User can disable reputation (permissions)</change>
					<change>User can ignore limitation (permissions)</change>
					<change>Add cancel button in reputation body</change>
					<change>Display reputation point in viewprofile</change>
					<change>Admin can edit user's reputation points</change>
				</changelog>
			</entry>
			<entry>
				<date>2008-02-25</date>
				<rev-version>0.0.1</rev-version>
				<changelog lang="en">
					<change>Initial release</change>
				</changelog>
			</entry>
		</history>
	</header>
	<action-group>
		<copy>
			<file from="root/reputation.php" to="reputation.php"/>
			<file from="root/viewreputation.php" to="viewreputation.php"/>
			<file from="root/db_install.php" to="db_install.php"/>
			<file from="root/adm/style/acp_rep_change_point.html" to="adm/style/acp_rep_change_point.html"/>
			<file from="root/adm/style/acp_rep_ranks.html" to="adm/style/acp_rep_ranks.html"/>
			<file from="root/images/reputation/*.*" to="images/reputation/*.*"/>
			<file from="root/includes/functions_reputation.php" to="includes/functions_reputation.php"/>
			<file from="root/includes/acp/acp_rep_change_point.php" to="includes/acp/acp_rep_change_point.php"/>
			<file from="root/includes/acp/acp_rep_ranks.php" to="includes/acp/acp_rep_ranks.php"/>
			<file from="root/includes/acp/acp_rep_settings.php" to="includes/acp/acp_rep_settings.php"/>
			<file from="root/includes/acp/info/acp_rep_change_point.php" to="includes/acp/info/acp_rep_change_point.php"/>
			<file from="root/includes/acp/info/acp_rep_ranks.php" to="includes/acp/info/acp_rep_ranks.php"/>
			<file from="root/includes/acp/info/acp_rep_settings.php" to="includes/acp/info/acp_rep_settings.php"/>
			<file from="root/language/en/mods/info_acp_reputation.php" to="language/en/mods/info_acp_reputation.php"/>
			<file from="root/language/en/mods/permissions_reputation.php" to="language/en/mods/permissions_reputation.php"/>
			<file from="root/language/en/mods/reputation_mod.php" to="language/en/mods/reputation_mod.php"/>
			<file from="root/styles/prosilver/template/reputation_body.html" to="styles/prosilver/template/reputation_body.html"/>
			<file from="root/styles/prosilver/template/viewreputation_body.html" to="styles/prosilver/template/viewreputation_body.html"/>
		</copy>
		<open src="common.php">
			<edit>
				<find>require($phpbb_root_path . 'includes/constants.' . $phpEx);
require($phpbb_root_path . 'includes/db/' . $dbms . '.' . $phpEx);
require($phpbb_root_path . 'includes/utf/utf_tools.' . $phpEx);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
require($phpbb_root_path . 'includes/functions_reputation.' . $phpEx);
// end</action>
			</edit>
		</open>
		<open src="memberlist.php">
			<edit>
				<find>		if (!empty($profile_fields['row']))
		{
			$template-&gt;assign_vars($profile_fields['row']);
		}</find>
				<action type="before-add">// idiotnesia wuz here - user rep point
		$user->add_lang('mods/reputation_mod');
		$template-&gt;assign_vars(array(
			'S_REPUTATION'		=&gt; $member['user_hide_reputation'] ? false : true,
			'REPUTATION'		=&gt; $member['user_reputation'],
			'REP_POWER'			=&gt; $reputation-&gt;get_rep_power($member['user_posts'], $member['user_regdate'], $member['user_reputation'], $member['group_id']),
			)
		);
// end</action>
			</edit>
		</open>
		<open src="viewtopic.php">
			<edit>
				<find>// Setup look and feel
$user-&gt;setup('viewtopic', $topic_data['forum_style']);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
$user-&gt;add_lang('mods/reputation_mod');
// end</action>
			</edit>
			<edit>
				<find>// Does this topic contain a poll?</find>
				<action type="before-add">// idiotnesia wuz here - user rep point
$reputation-&gt;viewtopic($forum_id);
// end</action>
			</edit>
			<edit>
				<find>// Generate online information for user</find>
				<action type="before-add">// idiotnesia wuz here - user rep point
$reputation_cache = $reputation-&gt;get_user_reputation($id_cache);
// end</action>
			</edit>
			<edit>
				<find><![CDATA[	if (isset($cp_row['row']) && sizeof($cp_row['row']))
	{
		$postrow = array_merge($postrow, $cp_row['row']);
	}]]></find>
				<action type="after-add">// idiotnesia wuz here - user rep point
	$postrow = array_merge($postrow, $reputation-&gt;reputation_row($poster_id, $row['post_id'], $reputation_cache));
// end</action>
			</edit>
		</open>
		<open src="adm/style/acp_groups.html">
			<edit>
				<find><![CDATA[<dl>
		<dt><label for="group_legend">{L_GROUP_LEGEND}:</label></dt>
		<dd><input name="group_legend" type="checkbox" value="1" class="radio" id="group_legend"{GROUP_LEGEND} /></dd>
	</dl>]]></find>
				<action type="after-add"><![CDATA[	<dl>
		<dt><label for="group_reputation_power">{L_RP_GROUP_POWER}:</label></dt>
		<dd><input name="group_reputation_power" type="text" id="group_reputation_power" maxlength="4" size="4" value="{GROUP_REPUTATION_POWER}" /></dd></dd>
	</dl>]]></action>
			</edit>
		</open>
		<open src="includes/functions_user.php">
			<edit>
				<find>	$update_ary = array(
		FORUMS_TABLE			=&gt; array('forum_last_poster_name'),
		MODERATOR_CACHE_TABLE	=&gt; array('username'),
		POSTS_TABLE				=&gt; array('post_username'),
		TOPICS_TABLE			=&gt; array('topic_first_poster_name', 'topic_last_poster_name'),
	);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
	$update_ary[REPUTATIONS_TABLE] = array('username');
// end</action>
			</edit>
			<edit>
				<find>function user_delete($mode, $user_id, $post_username = false)
{
	global $cache, $config, $db, $user, $auth;
	global $phpbb_root_path, $phpEx;</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
	global $reputation;
// end</action>
			</edit>
			<edit>
				<find><![CDATA[	if ($user_row['user_avatar'] && $user_row['user_avatar_type'] == AVATAR_UPLOAD)
	{
		avatar_delete('user', $user_row);
	}]]></find>
				<action type="after-add">//idiotnesia wuz here
	$reputation-&gt;delete_user($user_id);
// end</action>
			</edit>
			<edit>
				<find>$user_attribute_ary = array('group_colour', 'group_rank', 'group_avatar', 'group_avatar_type', 'group_avatar_width', 'group_avatar_height', 'group_receive_pm', 'group_legend', 'group_message_limit', 'group_max_recipients', 'group_founder_manage', 'group_min_days', 'group_max_days', 'group_min_warnings', 'group_max_warnings', 'group_min_posts', 'group_max_posts', 'group_auto_default');</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
	$user_attribute_ary[] = 'group_reputation_power';
// end</action>
			</edit>
			<edit>
				<find>$attribute_ary = array(
		'group_colour'			=> 'string',
		'group_rank'			=> 'int',
		'group_avatar'			=> 'string',
		'group_avatar_type'		=> 'int',
		'group_avatar_width'	=> 'int',
		'group_avatar_height'	=> 'int',
	);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
	$attribute_ary['group_reputation_power'] = 'int';
// end</action>
			</edit>
		</open>
		<open src="includes/acp/acp_groups.php">
			<edit>
				<find>		$user-&gt;add_lang('acp/groups');</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
		$user-&gt;add_lang('mods/reputation_mod');
// end</action>
			</edit>
			<edit>
				<find>					if ($user-&gt;data['user_type'] == USER_FOUNDER)
					{
						$submit_ary['founder_manage'] = isset($_REQUEST['group_founder_manage']) ? 1 : 0;
					}</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
					$submit_ary['reputation_power'] = request_var('group_reputation_power', 0);
// end</action>
			</edit>
			<edit>
				<find>						$group_attributes = array();
						$test_variables = array(
							'rank'			=> 'int',
							'colour'		=> 'string',
							'avatar'		=> 'string',
							'avatar_type'	=> 'int',
							'avatar_width'	=> 'int',
							'avatar_height'	=> 'int',
							'receive_pm'	=> 'int',
							'legend'		=> 'int',
							'message_limit'	=> 'int',
							'max_recipients'=> 'int',
							'founder_manage'=> 'int',
							'skip_auth'		=> 'int',
							'min_days'		=> 'int', 
							'max_days'		=> 'int',
							'min_warnings'	=> 'int', 
							'max_warnings'	=> 'int', 
							'min_posts'		=> 'int', 
							'max_posts'		=> 'int', 
							'auto_default'	=> 'int'
						);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
						$test_variables[] = 'reputation_power';
// end</action>
			</edit>
			<edit>
				<find>					'L_AVATAR_EXPLAIN'	=&gt; sprintf($user-&gt;lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)),
					)
				);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
				$template-&gt;assign_vars(array(
					'GROUP_REPUTATION_POWER'	=&gt; (isset($group_row['group_reputation_power'])) ? $group_row['group_reputation_power'] : 0,
					)
				);
// end</action>
			</edit>
		</open>
		<open src="includes/ucp/ucp_main.php">
			<edit>
				<find><![CDATA[					'U_SEARCH_USER'		=> ($auth->acl_get('u_search')) ? append_sid("{$phpbb_root_path}search.$phpEx", 'author_id=' . $user->data['user_id'] . '&amp;sr=posts') : '',
				));]]></find>
				<action type="after-add">&#13;
// idiotnesia wuz here&#13;
				global $reputation;&#13;
				$reputation-&gt;display_comment($user-&gt;data['user_id'], 'ucp', 0, $config['rp_recent_points'], false);&#13;
// end</action>
			</edit>
		</open>
		<open src="includes/ucp/ucp_prefs.php">
			<edit>
				<find>			case 'personal':
				add_form_key('ucp_prefs_personal');</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
				$user-&gt;add_lang('mods/reputation_mod');
// end</action>
			</edit>
			<edit>
				<find><![CDATA[				if ($data['notifymethod'] == NOTIFY_IM && (!$config['jab_enable'] || !$user->data['user_jabber'] || !@extension_loaded('xml')))
				{
					// Jabber isnt enabled, or no jabber field filled in. Update the users table to be sure its correct.
					$data['notifymethod'] = NOTIFY_BOTH;
				}]]></find>
				<action type="before-add">// idiotnesia wuz here - user rep point
				$data['hidereputation'] = request_var('hidereputation', (bool) $user-&gt;data['user_hide_reputation']);
// end</action>
			</edit>
			<edit>
				<find>'user_lang'				=> $data['lang'],
							'user_timezone'			=> $data['tz'],
							'user_style'			=> $data['style'],
							'allow_all_comment'		=> $data['allow_all_comment'],
							'allow_friend_only'		=> $data['allow_friend_only'],
							'allow_friend_view'		=> $data['allow_friend_view'],
							'allow_comment_email'	=> $data['allow_comment_email'],
						);</find>
				<action type="after-add">// idiotnesia wuz here - user rep point
						$sql_ary['user_hide_reputation'] = $data['hidereputation'];
// end</action>
			</edit>
			<edit>
				<find><![CDATA[					'S_SELECT_NOTIFY'		=> ($config['jab_enable'] && $user->data['user_jabber'] && @extension_loaded('xml')) ? true : false)
				);]]></find>
				<action type="after-add"><![CDATA[// idiotnesia wuz here - user rep point
				$template->assign_vars(array(
					'S_HIDE_REPUTATION'	=> $data['hidereputation'],
					'S_CAN_HIDE_REPUTATION'	=> ($config['rp_enable'] && $auth->acl_get('u_rp_disable')) ? true : false,
					)
				);
// end]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/memberlist_view.html">
			<edit>
				<find><![CDATA[<dt>{L_TOTAL_POSTS}:</dt>
				<dd>{POSTS} <!-- IF S_DISPLAY_SEARCH -->| <strong><a href="{U_SEARCH_USER}">{L_SEARCH_USER_POSTS}</a></strong><!-- ENDIF -->
					<!-- IF POSTS_PCT --><br />({POSTS_PCT} / {POSTS_DAY})<!-- ENDIF -->
					<!-- IF POSTS_IN_QUEUE and U_MCP_QUEUE --><br />(<a href="{U_MCP_QUEUE}">{L_POSTS_IN_QUEUE}</a>)<!-- ELSEIF POSTS_IN_QUEUE --><br />({L_POSTS_IN_QUEUE})<!-- ENDIF -->
				</dd>]]></find>
				<action type="after-add"><![CDATA[			<!-- IF S_REPUTATION -->
			<dt>{L_RP_TOTAL_POINTS}:</dt> <dd>{REPUTATION}</dd>
			<dt>{L_RP_POWER}:</dt> <dd>{REP_POWER}</dd>
			<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/ucp_main_front.html">
			<edit>
				<find><![CDATA[	<h3>{L_YOUR_DETAILS}</h3>]]></find>
				<action type="before-add"><![CDATA[<!-- IF .reputation_row -->
	<h3>{L_RP_RECENT_POINTS}</h3>
	<table class="table1" cellspacing="0">
		<thead>
		<tr>
			<th class="name">{L_RP_POINTS}</th>
			<th class="name">{L_FROM}</th>
			<th class="name">{L_RP_COMMENTS}</th>
			<th class="name">{L_POSTS}</th>
		</tr>
		</thead>
		<tbody>
	<!-- BEGIN reputation_row -->
		<tr class="<!-- IF reputation_row.S_ROW_COUNT is even -->bg1<!-- ELSE -->bg2<!-- ENDIF -->">
			<td><span>{reputation_row.POINT_IMG}</span></td>
			<td><span>{reputation_row.FROM}</span></td>
			<td><span>{reputation_row.COMMENT}</span></td>
			<td><span><!-- IF reputation_row.POST_SUBJECT --><a href="{reputation_row.U_POST}">{reputation_row.POST_SUBJECT}</a><!-- ELSE -->{L_RP_NA}<!-- ENDIF --></span></td>
		</tr>
	<!-- END reputation_row -->
		</tbody>
	</table>
<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/ucp_prefs_personal.html">
			<edit>
				<find><![CDATA[	<!-- IF S_CAN_HIDE_ONLINE -->
		<dl>
			<dt><label for="hideonline0">{L_HIDE_ONLINE}:</label><br /><span>{L_HIDE_ONLINE_EXPLAIN}</span></dt>
			<dd>
				<label for="hideonline1"><input type="radio" name="hideonline" id="hideonline1" value="1"<!-- IF S_HIDE_ONLINE --> checked="checked"<!-- ENDIF --> /> {L_YES}</label>
				<label for="hideonline0"><input type="radio" name="hideonline" id="hideonline0" value="0"<!-- IF not S_HIDE_ONLINE --> checked="checked"<!-- ENDIF --> /> {L_NO}</label>
			</dd>
		</dl>
	<!-- ENDIF -->]]></find>
				<action type="after-add"><![CDATA[	<!-- IF S_CAN_HIDE_REPUTATION -->
		<dl>
			<dt><label for="hideonline0">{L_RP_HIDE}:</label></dt>
			<dd>
				<label for="hidereputation1"><input type="radio" name="hidereputation" id="hidereputation1" value="1"<!-- IF S_HIDE_REPUTATION --> checked="checked"<!-- ENDIF --> /> {L_YES}</label>
				<label for="hidereputation0"><input type="radio" name="hidereputation" id="hidereputation0" value="0"<!-- IF not S_HIDE_REPUTATION --> checked="checked"<!-- ENDIF --> /> {L_NO}</label>
			</dd>
		</dl>
	<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/viewtopic_body.html">
			<edit>
				<find><![CDATA[		<!-- BEGIN custom_fields -->
			<dd><strong>{postrow.custom_fields.PROFILE_FIELD_NAME}:</strong> {postrow.custom_fields.PROFILE_FIELD_VALUE}</dd>
		<!-- END custom_fields -->]]></find>
				<action type="after-add"><![CDATA[		<!-- IF S_REPUTATION and postrow.S_USER_REPUTATION -->
		<!-- IF S_REP_DISPLAY neq 'block' --><dd><strong>{L_RP_TOTAL_POINTS}:</strong> {postrow.REPUTATION_TEXT}<!-- ENDIF -->
		<!-- IF S_REP_DISPLAY neq 'text'  --><dd><!-- IF postrow.U_VIEW_REP --><a href="{postrow.U_VIEW_REP}" onclick="popup(this.href, 780, 550); return false;" ><!-- ENDIF -->{postrow.REPUTATION_BLOCK}<!-- IF postrow.U_VIEW_REP --></a><!-- ENDIF --></dd><!-- ENDIF -->
		<!-- IF postrow.S_GIVE_REPUTATION --><dd><a href="{postrow.U_ADD_POS}"><img src="{T_IMAGES_PATH}reputation/add.png" title="{L_RP_ADD_POINTS} {postrow.POST_AUTHOR}" alt="{L_RP_ADD_POINTS} {postrow.POST_AUTHOR}" /></a><!-- IF postrow.S_GIVE_NEGATIVE--><a href="{postrow.U_ADD_NEG}"><img src="{T_IMAGES_PATH}reputation/subtract.png" title="{L_RP_SUBTRACT_POINTS} {postrow.POST_AUTHOR}" alt="{L_RP_SUBTRACT_POINTS} {postrow.POST_AUTHOR}" /></a><!-- ENDIF --></dd><!-- ENDIF -->
		<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<diy-instructions lang="en">After perform file editing you must run db_install.php.</diy-instructions>
	</action-group>
</mod>
