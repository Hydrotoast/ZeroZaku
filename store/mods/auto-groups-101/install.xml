<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the
latest version of this MOD. Although MODs are checked before being
allowed in the MODs Database there is no guarantee that there are no
security problems within the MOD. No support will be given for MODs not
found within the MODs Database which can be found at
http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.0.1.xsd">
<header>
	<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
	<title lang="en">Auto Groups MOD</title>
	<description lang="en">Gives administrators options to place users in groups based on post count, membership days, and warning points</description>
	<author-notes lang="en">Loosely Based on the phpBB2 MOD of the same name by niles
		Additional translations are available in /language/
		To update from 1.0.0 to 1.0.1, simply re-copy the included files.
	</author-notes>
	<author-group>
		<author>
			<realname>Josh W</realname>
			<email>support@jd1.clawz.com</email>
			<username>A_Jelly_Doughnut</username>
			<homepage></homepage>
		</author>
	</author-group>
	<mod-version>
		<major>1</major>
		<minor>0</minor>
		<revision>1</revision>
	</mod-version>
	<installation>
		<level>intermediate</level>
		<time>600</time>
		<target-version>
			<target-primary>3.0</target-primary>
			<target-major allow="exact">3</target-major>
			<target-minor allow="exact">0</target-minor>
			<target-release allow="after-equal">0</target-release>
		</target-version>
	</installation>
	<history>
		<entry>
			<date>2008-01-13</date>
			<rev-version>
				<major>1</major>
				<minor>0</minor>
				<revision>0</revision>
			</rev-version>
			<changelog lang="en">
				<change>Initial Final Release</change>
			</changelog>
		</entry>
		<entry>
			<date>2008-04-11</date>
			<rev-version>
				<major>1</major>
				<minor>0</minor>
				<revision>1</revision>
			</rev-version>
			<changelog lang="en">
				<change>Fixed some bugs -- Fixes provided by CorporateGoth</change>
			</changelog>
		</entry>
	</history>
</header>
<action-group>
	<sql><![CDATA[ALTER TABLE phpbb_groups ADD group_min_posts MEDIUMINT(8) DEFAULT 0;
ALTER TABLE phpbb_groups ADD group_max_posts MEDIUMINT(8) DEFAULT 0;
ALTER TABLE phpbb_groups ADD group_min_warnings MEDIUMINT(8) DEFAULT 0;
ALTER TABLE phpbb_groups ADD group_max_warnings MEDIUMINT(8) DEFAULT 0;
ALTER TABLE phpbb_groups ADD group_min_days MEDIUMINT(8) DEFAULT 0;
ALTER TABLE phpbb_groups ADD group_max_days MEDIUMINT(8) DEFAULT 0;
ALTER TABLE phpbb_groups ADD group_auto_default TINYINT(1) DEFAULT 0;
ALTER TABLE phpbb_user_group ADD auto_group TINYINT(1) DEFAULT '0';]]></sql>
	<copy>
		<file from="root/language/en/mods/info_acp_auto_groups.php" to="language/en/mods/info_acp_auto_groups.php" />
		<file from="root/includes/functions_autogroup.php" to="includes/functions_autogroup.php" />
		<file from="root/adm/style/auto_groups.html" to="adm/style/auto_groups.html" />
	</copy>
	<open src="includes/functions.php">
		<edit>
			<find><![CDATA[// append/replace SID (may change during the session for AOL users)]]></find>
			<action type="after-add"><![CDATA[
			// Handle auto grouping
			if (!function_exists('auto_group'))
			{
				include($phpbb_root_path . 'includes/functions_autogroup.'.$phpEx);
			}
			auto_group();]]>
			</action>
		</edit>
	</open>
	<open src="includes/functions_posting.php">
		<edit>
			<find>
			<![CDATA[markread('post', $data['forum_id'], $data['topic_id'], $data['post_time']);]]>
			</find>
			<action type="after-add">
			<![CDATA[		$user->data['user_posts']++;
		if (!function_exists('auto_group'))
		{
			include($phpbb_root_path . 'includes/functions_autogroup.'.$phpEx);
		}
		auto_group();
		$user->data['user_posts']--;]]>
			</action>
		</edit>
	</open>
	<open src="includes/functions_admin.php">
		<edit>
			<find>
			<![CDATA[
	}

	// Remove topics now having no posts?]]>
			</find>
			<action type="before-add">
			<![CDATA[
		if (!function_exists('auto_group'))
		{
			global $phpEx;
			include($phpbb_root_path . 'includes/functions_autogroup.'.$phpEx);
		}
		auto_group(array_keys($post_counts));]]>
			</action>
		</edit>
	</open>
	<open src="includes/functions_user.php">
		<edit>
			<find>
			<![CDATA[
		'group_founder_manage'	=> 'int',
			]]>
			</find>
			<action type="after-add">
			<![CDATA[
		// auto group mod
		'group_min_days'		=> 'int',
		'group_max_days'		=> 'int',
		'group_min_warnings'	=> 'int',
		'group_max_warnings'	=> 'int',
		'group_min_posts'		=> 'int',
		'group_max_posts'		=> 'int',
		'group_auto_default'	=> 'int',]]>
			</action>
		</edit>
		<edit>
			<find><![CDATA[
			$group_only_ary = array('group_receive_pm', 'group_legend', 'group_message_limit',]]></find>
			<inline-edit>
				<inline-find><![CDATA['group_founder_manage']]></inline-find>
				<inline-action type="after-add"><![CDATA[, 'group_min_days', 'group_max_days', 'group_min_warnings', 'group_max_warnings', 'group_min_posts', 'group_max_posts', 'group_auto_default']]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[
		// Setting the log message before we set the group id (if group gets added)
		$log = ($group_id) ? 'LOG_GROUP_UPDATED' : 'LOG_GROUP_CREATED';]]></find>
			<action type="before-add"><![CDATA[
		if (!function_exists('auto_group'))
		{
			global $phpEx;
			include($phpbb_root_path . 'includes/functions_autogroup.'.$phpEx);
		}
		$make_default = false;
		$auto_add_users = auto_groups_create($group_id, $make_default);

		// now we have all the information to insert auto users into the table if required
		if (isset($auto_add_users) && sizeof($auto_add_users))
		{
			group_user_add($group_id, $auto_add_users, false, false, $make_default, 0, 0, false, 1);

			unset($auto_add_users);
		}
		// end auto groups mod]]>
			</action>
		</edit>
		<edit>
			<find>function group_user_add</find>
			<inline-edit>
				<inline-find>$group_attributes = false</inline-find>
				<inline-action type="after-add">, $auto_group = 0</inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[
				'user_pending'	=> (int) $pending,]]></find>
			<action type="after-add"><![CDATA[
				'auto_group'	=> (int) $auto_group,]]>
			</action>
		</edit>
		<edit>
			<find><![CDATA[
function group_user_del]]></find>
			<inline-edit>
				<inline-find>$group_name = false</inline-find>
				<inline-action type="after-add">, $auto_group = 0</inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[	
	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . "
		WHERE group_id = $group_id]]></find>
			<action type="after-add"><![CDATA[
			AND (auto_group = $auto_group
				OR auto_group = 1)]]></action>
		</edit>
	</open>
	<open src="includes/acp/acp_groups.php">
		<edit>
			<find><![CDATA[						'message_limit'		=> request_var('group_message_limit', 0),]]></find>
			<action type="after-add"><![CDATA[
						// auto groups mod
						'min_days'		=> request_var('min_group_days', 0),
						'max_days'		=> request_var('max_group_days', 0),
						'min_warnings'	=> request_var('min_group_warnings', 0),
						'max_warnings'	=> request_var('max_group_warnings', 0),
						'min_posts'		=> request_var('min_group_posts', 0),
						'max_posts'		=> request_var('max_group_posts', 0),
						'auto_default'	=> isset($_POST['group_auto_default']),]]>
			</action>
		</edit>
		<edit>
			<find><![CDATA[$test_variables = array]]></find>
			<inline-edit>
				<inline-find><![CDATA['founder_manage']]></inline-find>
				<inline-action type="after-add">
					<![CDATA[, 'min_days', 'max_days', 'min_warnings', 'max_warnings', 'min_posts', 'max_posts', 'auto_default']]>
				</inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[					'GROUP_HIDDEN'		=> $type_hidden,]]></find>
			<action type="after-add"><![CDATA[
					// auto group mod
					'MIN_GROUP_DAYS'		=> (isset($group_row['group_min_days'])) ? $group_row['group_min_days'] : 0,
					'MAX_GROUP_DAYS'		=> (isset($group_row['group_max_days'])) ? $group_row['group_max_days'] : 0,
					'MIN_GROUP_WARNINGS'	=> (isset($group_row['group_min_warnings'])) ? $group_row['group_min_warnings'] : 0,
					'MAX_GROUP_WARNINGS'	=> (isset($group_row['group_max_warnings'])) ? $group_row['group_max_warnings'] : 0,
					'MIN_GROUP_POSTS'		=> (isset($group_row['group_min_posts'])) ? $group_row['group_min_posts'] : 0,
					'MAX_GROUP_POSTS'		=> (isset($group_row['group_max_posts'])) ? $group_row['group_max_posts'] : 0,
					'S_GROUP_AUTO_DEFAULT'	=> (isset($group_row['group_auto_default']) && $group_row['group_auto_default']) ? ' checked="checked"' : '',]]>
			</action>
		</edit>
	</open>
	<open src="adm/style/acp_groups.html">
		<edit>
			<find><![CDATA[	
	<fieldset>
		<legend>{L_GROUP_AVATAR}</legend>]]></find>
		<action type="before-add"><![CDATA[
		<!-- INCLUDE auto_groups.html -->]]>
			</action>
		</edit>
	</open>
</action-group>
</mod>			