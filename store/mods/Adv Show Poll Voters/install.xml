<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.1.xsd">
  <header>
    <license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
    <title lang="en">Advanced Show Poll Voters</title>
    <description lang="en">After installing this when user creating poll, user will have option to show poll voters for public.</description>
    <author-notes lang="en">This mod is based on evaarties' Show Poll Voters for phpBB3</author-notes>
    <author-group>
      <author>
        <realname>Ernst Vaarties</realname>
        <username>evaarties</username>
      </author>
      <author>
        <realname>pungky</realname>
        <email>pungkerz@gmail.com</email>
        <username>idiotnesia</username>
        <homepage>http://www.phpbbindonesia.com/</homepage>
      </author>
    </author-group>
    <mod-version>0.0.1</mod-version>
    <installation>
      <level>easy</level>
      <time>600</time>
      <target-version>3.0.4</target-version>
    </installation>
    <history>
      <entry>
        <date>2008-12-16T00:00:00+07:00</date>
        <rev-version>0.0.1</rev-version>
        <changelog lang="en">
          <change>Initial release</change>
        </changelog>
      </entry>
    </history>
    <meta name="generator" content="Phpbb.ModTeam.Tools (c#)" />
  </header>
  <action-group>
    <sql>ALTER TABLE phpbb_topics ADD poll_show_voters TINYINT( 1 ) UNSIGNED NOT NULL DEFAULT 0;</sql>
    <open src="posting.php">
      <edit>
        <find><![CDATA[				'poll_vote_change'	=> 0
			);]]></find>
        <action type="after-add">// idiotnesia wuz here
			$topic_sql['poll_show_voters'] = 0;
// finish</action>
      </edit>
      <edit>
        <find>		$post_data['poll_vote_change'] = $post_data['poll_max_options'] = $post_data['poll_length'] = 0;</find>
        <action type="after-add">// idiotnesia wuz here
		$post_data['poll_show_voters'] = 0;
// finish</action>
      </edit>
      <edit>
        <find><![CDATA[		$post_data['poll_vote_change']	= ($auth->acl_get('f_votechg', $forum_id) && $auth->acl_get('f_vote', $forum_id) && isset($_POST['poll_vote_change'])) ? 1 : 0;]]></find>
        <action type="after-add">// idiotnesia wuz here
		$post_data['poll_show_voters'] = isset($_POST['poll_show_voters']) ? 1 : 0;
// finish</action>
      </edit>
      <edit>
        <find><![CDATA[			'img_status'		=> $img_status
		);]]></find>
        <action type="after-add">// idiotnesia wuz here
		$poll['poll_show_voters'] = $post_data['poll_show_voters'];
// finish</action>
      </edit>
      <edit>
        <find><![CDATA[		'POLL_LENGTH'			=> $post_data['poll_length'])
	);]]></find>
        <action type="after-add"><![CDATA[// idiotnesia wuz here
	$template->assign_vars(array(
		'SHOW_VOTERS_CHECKED'	=> (!empty($post_data['poll_show_voters'])) ? ' checked="checked"' : '')
	);
// finish]]></action>
      </edit>
    </open>
    <open src="viewtopic.php">
      <edit>
        <find>// Does this topic contain a poll?</find>
        <action type="before-add"><![CDATA[// idiotnesia wuz here
	$template->assign_vars(array(
		'S_SHOW_VOTERS'		=> ($topic_data['poll_show_voters']) ? true : false)
	);
// finish]]></action>
      </edit>
      <edit>
        <find>		$poll_info[$i]['poll_option_text'] = bbcode_nl2br($poll_info[$i]['poll_option_text']);
		$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);</find>
        <action type="after-add"><![CDATA[// idiotnesia wuz here
// some codes here taken from evaarties' show poll voters for phpbb3
		$sql_voters = '
			SELECT u.username, u.user_colour, pv.vote_user_id
			FROM ' . POLL_VOTES_TABLE . ' pv, ' . USERS_TABLE . ' u
			WHERE pv.topic_id = ' . $topic_id . '
				AND poll_option_id = ' . $poll_info[$i]['poll_option_id'] . '
				AND pv.vote_user_id = u.user_id
			ORDER BY u.username_clean ASC, pv.vote_user_id ASC';

		$results_voters = $db->sql_query($sql_voters);
		$voters_total = 0;
		$voters_string = "";

// Add all voters to a string.
		while ($row_voters = $db->sql_fetchrow($results_voters))
		{
			$voters_total = $voters_total + 1;
			$voters_string = $voters_string . ", " . get_username_string('full', $row_voters['vote_user_id'], $row_voters['username'], $row_voters['user_colour'], $row_voters['username']);
		}

		$voters_string = ltrim($voters_string, ", ");

// Add the string to the list.
		$poll_info[$i]['poll_option_voters'] = $voters_string;
		$db->sql_freeresult($results_voters);

// finish]]></action>
      </edit>
      <edit>
        <find><![CDATA[			'POLL_OPTION_IMG' 		=> $user->img('poll_center', $option_pct_txt, round($option_pct * 250)),]]></find>
        <action type="after-add"><![CDATA[// idiotnesia wuz here
			'POLL_OPTION_VOTERS' 	=> $poll_option['poll_option_voters'],
// finish]]></action>
      </edit>
    </open>
    <open src="includes/functions_posting.php">
      <edit>
        <find><![CDATA[					'poll_vote_change'	=> $poll['poll_vote_change'])
				);]]></find>
        <action type="after-add">
// idiotnesia wuz here
				$sql_data[TOPICS_TABLE]['sql']['poll_show_voters'] = $poll['poll_show_voters'];
// finish</action>
      </edit>
      <edit>
        <find><![CDATA[				'topic_attachment'			=> (!empty($data['attachment_data'])) ? 1 : (isset($data['topic_attachment']) ? $data['topic_attachment'] : 0),
			);]]></find>
        <action type="after-add">
// idiotnesia wuz here
			$sql_data[TOPICS_TABLE]['sql']['poll_show_voters'] = (isset($poll['poll_show_voters'])) ? $poll['poll_show_voters'] : 0;
// finsih</action>
      </edit>
    </open>
    <open src="language/en/posting.php">
      <edit>
        <find><![CDATA[?>]]></find>
        <action type="before-add"><![CDATA[$lang = array_merge($lang, array(
	'POLL_SHOW_VOTERS'		=> 'Show poll voters',
	'POLL_SHOW_VOTERS_EXPLAIN'	=> 'If enabled users are able to see the poll voters.',
));]]></action>
      </edit>
    </open>
    <open src="styles/prosilver/template/posting_poll_body.html">
      <edit>
        <find><![CDATA[		<!-- IF S_POLL_VOTE_CHANGE -->
			<hr class="dashed" />
			
			<dl>
				<dt><label for="poll_vote_change">{L_POLL_VOTE_CHANGE}:</label></dt>
				<dd><label for="poll_vote_change"><input type="checkbox" id="poll_vote_change" name="poll_vote_change"{VOTE_CHANGE_CHECKED} /> {L_POLL_VOTE_CHANGE_EXPLAIN}</label></dd>
			</dl>
		<!-- ENDIF -->]]></find>
        <action type="after-add"><![CDATA[			<dl>
				<dt><label for="poll_show_voters">{L_POLL_SHOW_VOTERS}:</label></dt>
				<dd><label for="poll_show_voters"><input type="checkbox" id="poll_show_voters" name="poll_show_voters"{SHOW_VOTERS_CHECKED} /> {L_POLL_SHOW_VOTERS_EXPLAIN}</label></dd>
			</dl>]]></action>
      </edit>
    </open>
    <open src="styles/prosilver/template/viewtopic_body.html">
      <edit>
        <find><![CDATA[					<!-- IF S_DISPLAY_RESULTS --><dd class="resultbar"><div class="<!-- IF poll_option.POLL_OPTION_PCT < 20 -->pollbar1<!-- ELSEIF poll_option.POLL_OPTION_PCT < 40 -->pollbar2<!-- ELSEIF poll_option.POLL_OPTION_PCT < 60 -->pollbar3<!-- ELSEIF poll_option.POLL_OPTION_PCT < 80 -->pollbar4<!-- ELSE -->pollbar5<!-- ENDIF -->" style="width:{poll_option.POLL_OPTION_PERCENT};">{poll_option.POLL_OPTION_RESULT}</div></dd>
					<dd><!-- IF poll_option.POLL_OPTION_RESULT == 0 -->{L_NO_VOTES}<!-- ELSE -->{poll_option.POLL_OPTION_PERCENT}<!-- ENDIF --></dd><!-- ENDIF -->]]></find>
        <inline-edit>
          <inline-find><![CDATA[{poll_option.POLL_OPTION_PERCENT}<!-- ENDIF -->]]></inline-find>
          <inline-action type="after-add"><![CDATA[<!-- IF S_SHOW_VOTERS --><!-- IF not S_CAN_VOTE --><dt>&nbsp;</dt><!-- ENDIF --><dd class="resultbar">{poll_option.POLL_OPTION_VOTERS}</dd><!-- ENDIF -->]]></inline-action>
        </inline-edit>
      </edit>
    </open>
    <diy-instructions lang="en">After installing this mod go to acp then purge the cache</diy-instructions>
  </action-group>
</mod>