<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="./modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http
://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.2.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
		<title lang="en">Welcome PM on first Login (WPM)</title>
		<description lang="en">Allows the admin to configure a welcome private message that will be sent out to newly registered users on their first login.</description>
		<author-notes lang="en">This mod was adjusted for phpbb3 GOLD by ..::Frans::.. Mod was taken over from and with explicit permission from Dualfusion. Credits for the original code go entirely to him.</author-notes>
		<author-group>
			<author>
				<realname>Kevin Martin</realname>
				<email>yusuka_madik@yahoo.com</email>
				<username>DualFusion</username>
				<homepage>http://dualfusion.freehostia.com/</homepage>
				<contributions />
			</author>
			<author>
				<realname>Frans</realname>
				<username>..::Frans::..</username>
				<homepage>http://www.startrekguide.com/</homepage>
				<contributions />
			</author>
		</author-group>
		<mod-version>2.2.5</mod-version>

		<installation>
			<level>easy</level>
			<time>420</time>
			<target-version>3.0.5</target-version>
		</installation>

		<history>
			<entry>
				<date>2007-08-07</date>
				<rev-version>1.0.0</rev-version>
				<changelog lang="en">
					<change>Version 1.0.0 - Initial release by DualFusion. RC2 - RC4 compatible</change>
				</changelog>
			</entry>

			<entry>
				<date>2007-12-31</date>
				<rev-version>2.0.0a</rev-version>
				<changelog lang="en">
					<change>Version 2.0.0a - Alpha release by DualFusion RC7 compatible.</change>
					<change>Bug Fixes.</change>
					<change>Added Table to make message longer as 255 chars.</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-01-19</date>
				<rev-version>2.1.0a</rev-version>
				<changelog lang="en">
					<change>Version 2.1.0a - First release by ..::Frans::.. GOLD compatible.</change>
					<change>Changed entire code to reflect the correct GOLD functionality</change>
					<change>Expanded WPM table to hold all of the WPM variables.</change>
					<change>Removed all configuration setting sfrom the config Table.</change>
					<change>Created new class for sending PM's.</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-01-19</date>
				<rev-version>2.1.1a</rev-version>
				<changelog lang="en">
					<change>Version 2.1.1a - Release by ..::Frans::.. GOLD compatible.</change>
					<change>Few minor bugfixes</change>
					<change>Fixed bug with languages that use non-standard characters (greek/french etc.).</change>
					<change>Cleaned up code.</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-01-19</date>
				<rev-version>2.1.2</rev-version>
				<changelog lang="en">
					<change>Version 2.1.2 - Release by ..::Frans::.. GOLD compatible.</change>
					<change>Few minor bugfixes</change>
					<change>Cleaned up code.</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-01-19</date>
				<rev-version>2.2.0</rev-version>
				<changelog lang="en">
					<change>Version 2.2.0 - Release by ..::Frans::.. GOLD compatible.</change>
					<change>Few minor bugfixes</change>
					<change>Made some changes to coding so objects are used correct way</change>
					<change>Forgot to give Dualfusion proper credit in the ModX file (shame on me!)</change>
					<change>Added PM Notification support so the new user WILL get a popup message when logging on the first time</change>
					<change>There were 2 spots in the code that didn't have spaces around the dots. Added spaces.</change>
					<change>Changed all apostrofs in the install text to backticks.</change>
					<change>Changed version number to 2.2.0 to reflect the correct version number.</change>
					<change>Cleaned up code.</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-02-17</date>
				<rev-version>2.2.1</rev-version>
				<changelog lang="en">
					<change>Version 2.2.1 - Release by ..::Frans::.. GOLD compatible.</change>
					<change>Few minor bugfixes</change>
					<change>Fixed all coding according to the coding guidelines</change>
					<change>Fixed the nasty bug that was getting back to me when users with multibyte characters got ??? instead of the normal text</change>
					<change>Cleaned up code.</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-04-11</date>
				<rev-version>2.2.2</rev-version>
				<changelog lang="en">
					<change>Version 2.2.2 - Release by ..::Frans::.. phpbb 3.0.1 compatible.</change>
					<change>Few minor bugfixes</change>
					<change>Some minor changes to repair compatibilty with version 3.0.1.</change>
					<change>Fixed more coding according to the coding guidelines</change>
					<change>Fixed modx (this) file to reflect some minor errors (tabs and spaces)</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-05-20</date>
				<rev-version>2.2.3</rev-version>
				<changelog lang="en">
					<change>Version 2.2.3 - Release by ..::Frans::.. phpbb 3.0.1 compatible.</change>
					<change>Fixed a small but rather nasty bug where in rare cases banned people could log on.(Thnx go to WhiteWolfSix!)</change>
				</changelog>
			</entry>

			<entry>
				<date>2008-07-29</date>
				<rev-version>2.2.4</rev-version>
				<changelog lang="en">
					<change>Version 2.2.4 - Release by ..::Frans::.. phpbb 3.0.2 compatible.</change>
					<change>Changed package to be compatible with the new ModX 1.2.0 Format.</change>
					<change>Made mod completely phpbb 3.0.2 compatible</change>
				</changelog>
			</entry>
			<entry>
				<date>2009-05-18</date>
				<rev-version>2.2.5</rev-version>
				<changelog lang="en">
					<change>Version 2.2.5 - Release by ..::Frans::.. phpbb 3.0.5 compatible.</change>
					<change>Changed package to be compatible with the new ModX 1.2.2 Format.</change>
					<change>Made mod completely phpbb 3.0.5 compatible</change>
					<change>Repack for phpbb.com validation</change>
					<change>Installs correctly with automod RC1</change>
				</changelog>
			</entry>
		</history>
	</header>
	<action-group>

	<sql>
	<![CDATA[CREATE TABLE phpbb_wpm (
	wpm_config_id int(3) NOT NULL,
	wpm_enable tinyint(1) unsigned NOT NULL,
	wpm_send_id mediumint(8) NOT NULL,
	wpm_preview tinyint(1) unsigned NOT NULL,
	wpm_variables varchar(255) NOT NULL,
	wpm_subject varchar(100) NOT NULL,
	wpm_message mediumtext NOT NULL,
	wpm_version varchar(255) NOT NULL,
	PRIMARY KEY	(wpm_config_id)
	) ;

	INSERT INTO phpbb_wpm (wpm_config_id, wpm_enable, wpm_send_id, wpm_preview, wpm_variables, wpm_subject, wpm_message, wpm_version) VALUES(1, 1, 2, 0, '', 'Welcome to {SITE_NAME}!', 'Hello, [b]{USERNAME}[/b]!\n\nWelcome to {SITE_NAME}	({SITE_DESC})\n\nYou registered on [b]{USER_REGDATE}[/b]. According to your input, your email is [b]{USER_EMAIL}[/b] and you live in timezone [b]{USER_TZ}[/b]. It is nice to know that you speak {USER_LANG_LOCAL}.\n\nYou can contact us here: {BOARD_CONTACT} or here: {BOARD_EMAIL}, whichever you prefer, at anytime. Thank you for choosing us.\n\n-Thank you for registering at {SITE_NAME}!\n\nThanks, {SENDER}', '2.2.5');
	]]>
	</sql>

	<copy>
		<file from="root/adm/style/acp_wpm.html" to="adm/style/acp_wpm.html" />
		<file from="root/adm/style/posting_buttons.html" to="adm/style/posting_buttons.html" />
		<file from="root/includes/functions_wpm.php" to="includes/functions_wpm.php" />
		<file from="root/includes/acp/acp_wpm.php" to="includes/acp/acp_wpm.php" />
		<file from="root/includes/acp/info/acp_wpm.php" to="includes/acp/info/acp_wpm.php" />
		<file from="root/language/en/mods/info_acp_wpm.php" to="language/en/mods/info_acp_wpm.php" />
	</copy>

	<open src="includes/constants.php">
		<edit>
			<find><![CDATA[// Additional constants]]></find>
			<action type="after-add"><![CDATA[define('WPM_CONFIG_ID', 1);]]></action>
		</edit>
		<edit>
			<find><![CDATA[?>]]></find>
			<action type="before-add"><![CDATA[define('WPM_TABLE',					$table_prefix . 'wpm');]]></action>
		</edit>
	</open>
	<open src="includes/functions.php">
		<edit>
			<find><![CDATA[			// Special case... the user is effectively banned, but we allow founders to login
			if (defined('IN_CHECK_BAN') && $result['user_row']['user_type'] != USER_FOUNDER)
			{
				return;
			}

			]]>
			</find>
			<action type="after-add"><![CDATA[			/*
			* Welcome PM on First Login (WPM)
			* By DualFusion /adjusted by ..::Frans::.. for phpbb3 GOLD
			*/
			$sql = 'SELECT wpm_enable FROM '.WPM_TABLE.' WHERE wpm_config_id =1';
			$result = $db->sql_query($sql);
			$row = $db->sql_fetchrow($result);
			$db->sql_freeresult($result);


			if($row['wpm_enable'] && $user->data['user_lastvisit'] == 0)
			{
				include($phpbb_root_path . 'includes/functions_wpm.' . $phpEx);
				$wpm = new welcome_pm();
				$wpm->get_vars();
				$wpm->send_wpm();
			}
			/* End WPM */

			]]>
			</action>
		</edit>
	</open>

	<diy-instructions lang="en">After installation you need to purge the cache and install the module inside ACP.</diy-instructions>

	</action-group>
</mod>